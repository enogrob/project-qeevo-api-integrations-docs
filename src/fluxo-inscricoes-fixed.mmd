%%{init: {
    "theme": "base",
    "themeVariables": {
        "fontFamily": "arial",
        "fontSize": "12px",
        "primaryColor": "#ffffff",
        "primaryTextColor": "#2c3e50",
        "primaryBorderColor": "#34495e",
        "lineColor": "#34495e",
        "sectionBkgColor": "transparent",
        "altSectionBkgColor": "transparent",
        "gridColor": "#ecf0f1",
        "c0": "#ecf0f1",
        "c1": "#bdc3c7",
        "c2": "#95a5a6",
        "c3": "#7f8c8d"
    }
}}%%

flowchart TD
    
    subgraph SG1 ["🎯 Student Journey"]
        INICIO(("`🚀 **Início**
        Aluno interessado
        na bolsa`"))
        CADASTRO["`📝 **Cadastro**
        E-mail, CPF, Nome
        Nascimento, Celular, CEP`"]
        FIM(("`✅ **Fim**
        Processo Concluído`"))
        LEAD_SOLD(("`💰 **Lead Vendido**
        Conversão realizada`"))
    end
    
    subgraph SG2 ["💳 Payment & Admission Process"]
        PAYMENT_CHECK{"`💳 **Pagamento PEF?**
        Processo de pagamento`"}
        DIGITAL_ADMISSION{"`💻 **Admissão Digital?**
        Processo automatizado`"}
        API_CHECK{"`🔌 **API de Inscrições?**
        Integração disponível`"}
        
        subgraph SG3 ["📋 Document Management"]
            SEND_DOCS["`📄 **Enviar Documentos**
            Upload de arquivos`"]
            DOC_CHECK{"`✅ **Documentação OK?**
            Validação de documentos`"}
            REJECT_DOCS["`❌ **Rejeitar Docs**
            Documentos inválidos`"]
        end
        
        subgraph SG4 ["🎓 Enrollment Process"]
            ENROLL_DATA["`📊 **Matrícula com Dados**
            Processamento de inscrição`"]
            STUDENT_ENROLLED["`🎉 **Aluno Matriculado**
            Sucesso na matrícula`"]
            VOUCHER["`🎫 **Comprovante Bolsa**
            Documento de confirmação`"]
            CAMPUS_ENROLL["`🏛️ **Matrícula no Campus**
            Processo presencial`"]
        end
    end
    
    subgraph SG5 ["⚙️ Integration Systems"]
        INTEGRATION_TYPE{"`🔧 **Tipo de Integração**
        Sistema de destino`"}
        API_INTEGRATION{"`🔌 **API?**
        Integração automatizada`"}
        
        subgraph SG6 ["🔄 Kroton Integration"]
            KROTON_CHECK{"`🎓 **Kroton?**
            Sistema Kroton`"}
            KROTON_MODE{"`📚 **Modalidade Kroton**
            Tipo de curso`"}
            
            SYNC_COURSE["`🔄 **Cron Job sync_course**
            Sincronização de cursos`"]
            KROTON_BD_1["`🗄️ **Popula BD**
            Inscrições Kroton`"]
            KROTON_SEND_1["`📡 **Envio para IES**
            Dados do aluno`"]
            KROTON_ERROR_1{"`⚠️ **Erro no Envio?**
            Falha na transmissão`"}
            KROTON_RETRY["`🔄 **Reenvio Automático**
            Tentativa automática`"]
            
            KROTON_BD_2["`🗄️ **Popula BD**
            Inscrições presenciais`"]
            KROTON_SEND_2["`📡 **Envio para IES**
            Modalidade presencial`"]
        end
        
        subgraph SG7 ["🏛️ Estácio Integration"]
            ESTACIO_BD["`🗄️ **Popula BD**
            Inscrições Estácio`"]
            ONETRUST["`🛡️ **OneTrust**
            Compliance LGPD`"]
            ESTACIO_SEND["`📡 **Envio para IES**
            Sistema Estácio`"]
            ESTACIO_ERROR{"`⚠️ **Erro no Envio?**
            Falha na transmissão`"}
            MANUAL_SEND["`✋ **Envio Manual**
            Intervenção necessária`"]
        end
        
        subgraph SG8 ["🕷️ Crawler Integration"]
            CRAWLER_BD["`🗄️ **BD Subscribe Bot**
            Sistema de captura`"]
            CRAWLER_SEND["`📡 **Envio para IES**
            Via crawler`"]
        end
        
        subgraph SG9 ["📊 Lead Management"]
            LEAD_BD_KROTON["`🗄️ **BD Inscrições**
            Type: captação`"]
            LEAD_ONETRUST["`🛡️ **OneTrust Lead**
            LGPD para leads`"]
            LEAD_SEND_KROTON["`📡 **Envio Lead**
            codAgentPdv: 14412833`"]
            
            LEAD_BD_ESTACIO["`🗄️ **BD Inscrições**
            Separação por tipo`"]
            LEAD_SEND_ESTACIO["`📡 **Envio Lead**
            Sistema Estácio`"]
        end
    end
    
    subgraph SG10 ["🔧 Legacy Process"]
        CONFIG_CHECK{"`⚙️ **Config Admissão?**
        Configuração disponível`"}
        ADMISSION_CHECK{"`🎯 **admission_created?**
        Processo criado`"}
        ENROLL_CHECK{"`📋 **admission_enroll?**
        Matrícula disponível`"}
        
        CONTRACT_1["`📋 **Assinar Contrato**
        Primeira assinatura`"]
        SEND_DOCS_1["`📄 **Envio Documentos**
        Primeira remessa`"]
        SELECTIVE_1["`🎯 **Processo Seletivo**
        Primeira avaliação`"]
        
        CONTRACT_2["`📋 **Assinar Contrato**
        Segunda assinatura`"]
        SEND_DOCS_2["`📄 **Envio Documentos**
        Segunda remessa`"]
        SELECTIVE_2["`🎯 **Processo Seletivo**
        Segunda avaliação`"]
    end
    
    %% Main Flow
    INICIO --> CADASTRO
    CADASTRO --> PAYMENT_CHECK
    
    %% Payment Flow
    PAYMENT_CHECK -->|"`💳 **Sim**
    Processo PEF`"| DIGITAL_ADMISSION
    PAYMENT_CHECK -->|"`❌ **Não**
    Sem pagamento`"| INTEGRATION_TYPE
    
    %% Digital Admission Flow
    DIGITAL_ADMISSION -->|"`💻 **Sim**
    Processo digital`"| API_CHECK
    DIGITAL_ADMISSION -->|"`📋 **Não**
    Processo manual`"| API_CHECK
    
    API_CHECK -->|"`🔌 **Sim**
    API disponível`"| SEND_DOCS
    API_CHECK -->|"`❌ **Não**
    Sem API`"| CONFIG_CHECK
    
    %% Document Management Flow
    SEND_DOCS --> DOC_CHECK
    DOC_CHECK -->|"`✅ **Sim**
    Documentos OK`"| ENROLL_DATA
    DOC_CHECK -->|"`❌ **Não**
    Documentos inválidos`"| REJECT_DOCS
    REJECT_DOCS --> ENROLL_DATA
    
    %% Enrollment Flow
    ENROLL_DATA --> STUDENT_ENROLLED
    STUDENT_ENROLLED --> VOUCHER
    VOUCHER --> FIM
    
    %% Legacy Configuration Flow
    CONFIG_CHECK -->|"`❌ **Não**
    Sem configuração`"| ADMISSION_CHECK
    CONFIG_CHECK -->|"`✅ **Sim**
    Com configuração`"| ENROLL_CHECK
    
    ADMISSION_CHECK -->|"`✅ **Sim**
    Admissão criada`"| CONTRACT_1
    ADMISSION_CHECK -->|"`❌ **Não**
    Sem admissão`"| ENROLL_DATA
    
    CONTRACT_1 --> SEND_DOCS_1
    SEND_DOCS_1 --> SELECTIVE_1
    SELECTIVE_1 --> ENROLL_DATA
    
    ENROLL_CHECK -->|"`✅ **Sim**
    Matrícula habilitada`"| CONTRACT_2
    ENROLL_CHECK -->|"`❌ **Não**
    Matrícula direta`"| SELECTIVE_2
    
    CONTRACT_2 --> SEND_DOCS_2
    SEND_DOCS_2 --> SELECTIVE_2
    SELECTIVE_2 --> ENROLL_DATA
    
    %% Integration Flow
    INTEGRATION_TYPE --> API_INTEGRATION
    API_INTEGRATION -->|"`🔌 **Sim**
    API disponível`"| KROTON_CHECK
    API_INTEGRATION -->|"`🕷️ **Crawler**
    Captura automatizada`"| CRAWLER_BD
    
    %% Kroton Integration Flow
    KROTON_CHECK -->|"`🎓 **Kroton**
    Sistema Kroton`"| KROTON_BD_1
    KROTON_CHECK -->|"`🏛️ **Estácio**
    Sistema Estácio`"| ESTACIO_BD
    
    KROTON_BD_1 --> LEAD_ONETRUST
    LEAD_ONETRUST --> LEAD_SEND_KROTON
    LEAD_SEND_KROTON --> LEAD_SOLD
    
    ESTACIO_BD --> LEAD_BD_ESTACIO
    LEAD_BD_ESTACIO --> LEAD_SEND_ESTACIO
    LEAD_SEND_ESTACIO --> LEAD_SOLD
    
    %% Crawler Flow
    CRAWLER_BD --> CRAWLER_SEND
    CRAWLER_SEND --> LEAD_SOLD
    
    %% Legacy Kroton Flow for non-API
    API_CHECK -->|"`❌ **Não**
    Kroton sem API`"| KROTON_MODE
    KROTON_MODE -->|"`📚 **Semipresencial**
    Modalidade híbrida`"| SYNC_COURSE
    KROTON_MODE -->|"`🏛️ **Presencial**
    Modalidade campus`"| KROTON_BD_2
    
    SYNC_COURSE --> KROTON_BD_1
    KROTON_BD_1 --> KROTON_SEND_1
    KROTON_SEND_1 --> KROTON_ERROR_1
    KROTON_ERROR_1 -->|"`✅ **Não**
    Sucesso`"| IES_NOTIFICATION
    KROTON_ERROR_1 -->|"`⚠️ **Sim**
    Erro ocorrido`"| KROTON_RETRY
    KROTON_RETRY --> IES_NOTIFICATION
    
    KROTON_BD_2 --> KROTON_SEND_2
    KROTON_SEND_2 --> KROTON_ERROR_1
    
    %% Estácio Flow for non-API
    API_CHECK -->|"`❌ **Não**
    Estácio sem API`"| ESTACIO_BD
    ESTACIO_BD --> ONETRUST
    ONETRUST --> ESTACIO_SEND
    ESTACIO_SEND --> ESTACIO_ERROR
    ESTACIO_ERROR -->|"`✅ **Não**
    Sucesso`"| IES_NOTIFICATION
    ESTACIO_ERROR -->|"`⚠️ **Sim**
    Erro ocorrido`"| MANUAL_SEND
    MANUAL_SEND --> IES_NOTIFICATION
    
    %% Final notification
    IES_NOTIFICATION["`📢 **IES Notifica**
    Confirmação do processo`"]
    IES_NOTIFICATION --> CAMPUS_ENROLL
    CAMPUS_ENROLL --> FIM
    
    %% Final Lead Flow
    LEAD_SOLD --> FIM
    
    %% ===== STYLING SECTION =====
    %% Custom color scheme as requested
    
    %% Start/End nodes - Yellow
    classDef startEndClass fill:#fff3cd,stroke:#ffc107,stroke-width:3px,color:#856404
    
    %% Decision/IF nodes - Pink (more vibrant pink)
    classDef decisionClass fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    
    %% Action/Process nodes - Grey
    classDef actionClass fill:#e9ecef,stroke:#6c757d,stroke-width:2px,color:#495057
    
    %% Comment/Document nodes - Green
    classDef commentClass fill:#d4edda,stroke:#28a745,stroke-width:2px,color:#155724
    
    %% Integration nodes - Light Blue (for database/integration operations)
    classDef integrationClass fill:#d1ecf1,stroke:#17a2b8,stroke-width:2px,color:#0c5460
    
    %% Error nodes - Red
    classDef errorClass fill:#f5c6cb,stroke:#dc3545,stroke-width:2px,color:#721c24
    
    %% Apply classes to nodes
    class INICIO,FIM,LEAD_SOLD startEndClass
    class PAYMENT_CHECK,DIGITAL_ADMISSION,API_CHECK,DOC_CHECK,CONFIG_CHECK,ADMISSION_CHECK,ENROLL_CHECK,INTEGRATION_TYPE,API_INTEGRATION,KROTON_CHECK,KROTON_MODE,KROTON_ERROR_1,ESTACIO_ERROR decisionClass
    class CADASTRO,ENROLL_DATA,STUDENT_ENROLLED,VOUCHER,CAMPUS_ENROLL,SYNC_COURSE,KROTON_SEND_1,KROTON_SEND_2,ESTACIO_SEND,CRAWLER_SEND,LEAD_SEND_KROTON,LEAD_SEND_ESTACIO,IES_NOTIFICATION,SELECTIVE_1,SELECTIVE_2 actionClass
    class SEND_DOCS,REJECT_DOCS,CONTRACT_1,SEND_DOCS_1,CONTRACT_2,SEND_DOCS_2,ONETRUST,LEAD_ONETRUST commentClass
    class KROTON_BD_1,KROTON_BD_2,ESTACIO_BD,CRAWLER_BD,LEAD_BD_KROTON,LEAD_BD_ESTACIO integrationClass
    class KROTON_RETRY,MANUAL_SEND errorClass
    
    %% Force pink styling for decision nodes (override any theme conflicts)
    style PAYMENT_CHECK fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    style DIGITAL_ADMISSION fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    style API_CHECK fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    style DOC_CHECK fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    style CONFIG_CHECK fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    style ADMISSION_CHECK fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    style ENROLL_CHECK fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    style INTEGRATION_TYPE fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    style API_INTEGRATION fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    style KROTON_CHECK fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    style KROTON_MODE fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    style KROTON_ERROR_1 fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    style ESTACIO_ERROR fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f